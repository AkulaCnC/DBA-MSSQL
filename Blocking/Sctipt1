-- See blocking sessions

SELECT
    r.session_id AS [Blocked Session],
    r.blocking_session_id AS [Blocking Session],
    r.wait_type,
    r.wait_time,
    r.status,
    r.command,
    t.text AS [SQL Text],
    s.program_name,
    s.host_name,
    s.login_name
FROM sys.dm_exec_requests r
JOIN sys.dm_exec_sessions s ON r.session_id = s.session_id
CROSS APPLY sys.dm_exec_sql_text(r.sql_handle) AS t
WHERE r.blocking_session_id <> 0;


-- Shows blocking chain and identifies lead blockers

SELECT
    session_id,
    blocking_session_id,
    wait_type,
    wait_time,
    wait_resource,
    (SELECT text FROM sys.dm_exec_sql_text(sql_handle)) AS [SQL Text]
FROM sys.dm_exec_requests
WHERE blocking_session_id = 0
AND session_id IN (
    SELECT DISTINCT blocking_session_id
    FROM sys.dm_exec_requests
    WHERE blocking_session_id <> 0
);


--Use this to find sleeping sessions with open transactions:-- Monitor and Kill Old Sleeping Sessions (if needed)


SELECT
    s.session_id,
    s.status,
    r.command,
    r.status AS request_status,
    r.wait_type,
    r.wait_time,
    t.text AS [SQL Text]
FROM sys.dm_exec_sessions s
LEFT JOIN sys.dm_exec_requests r ON s.session_id = r.session_id
CROSS APPLY sys.dm_exec_sql_text(r.sql_handle) AS t
WHERE s.status = 'sleeping'
AND EXISTS (
    SELECT 1 FROM sys.dm_tran_session_transactions ts WHERE ts.session_id = s.session_id
);




